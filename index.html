<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת גמ"ח למסירה</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f1f8ff;
            border-bottom: 1px solid #e3f2fd;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .preview-container {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 20px;
            background-color: white;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .item-list {
            list-style-type: none;
            padding: 0;
        }
        .item-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #pdfPreview {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
        }
        .tab-content {
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: 0;
            border-radius: 0 0 5px 5px;
            padding: 20px;
        }
        .logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        #importSection {
            border: 2px dashed #3498db;
            padding: 20px;
            border-radius: 10px;
            background-color: #f7fbff;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="bi bi-gift"></i> מערכת גמ"ח למסירה</h1>
            <p class="lead">יצירת הודעות מסירה בקלות ובמהירות</p>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab" aria-controls="create" aria-selected="true">יצירת הודעה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">תצוגה מקדימה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf" type="button" role="tab" aria-controls="pdf" aria-selected="false">PDF ושליחה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">הגדרות</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- יצירת הודעה חדשה -->
            <div class="tab-pane fade show active" id="create" role="tabpanel" aria-labelledby="create-tab">
                <!-- אזור ייבוא מטקסט -->
                <div id="importSection">
                    <h5><i class="bi bi-clipboard-data"></i> העתק והדבק מהמייל</h5>
                    <p class="small">העתק את הטקסט מהמייל והדבק כאן. המערכת תנסה למלא את השדות באופן אוטומטי.</p>
                    <div class="mb-3">
                        <textarea class="form-control" id="importText" rows="6" placeholder="הדבק את הטקסט המלא כאן..."></textarea>
                    </div>
                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-primary" id="btnImport" onclick="parseImportedText()">
                            <i class="bi bi-magic"></i> מלא שדות אוטומטית
                        </button>
                        <button class="btn btn-outline-secondary" id="btnClearImport" onclick="clearImportText()">
                            <i class="bi bi-trash"></i> נקה
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>פרטי ההודעה</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">כותרת</label>
                            <input type="text" class="form-control" id="title" value="">
                        </div>
                        <div class="mb-3">
                            <label for="subtitle" class="form-label">תת כותרת</label>
                            <input type="text" class="form-control" id="subtitle" value="למסירה:">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">פריטים למסירה</label>
                            <div class="input-group mb-2">
                                <input type="text" id="newItem" class="form-control" placeholder="תיאור הפריט">
                                <button class="btn btn-success" id="addItem"><i class="bi bi-plus-lg"></i> הוסף</button>
                            </div>
                            <ul class="item-list" id="itemsList"></ul>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">מיקום האיסוף</label>
                            <input type="text" class="form-control" id="location" value="">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">מספר טלפון</label>
                            <input type="tel" class="form-control" id="phone" value="">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">כתובת מייל</label>
                            <input type="email" class="form-control" id="email" value="">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>תמונות</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="formFileMultiple" class="form-label">בחר תמונות להעלאה</label>
                            <input class="form-control" type="file" id="formFileMultiple" multiple accept="image/*">
                        </div>
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-primary" id="btnPreview" onclick="showPreviewTab()">
                        <i class="bi bi-eye"></i> תצוגה מקדימה
                    </button>
                </div>
            </div>

            <!-- תצוגה מקדימה -->
            <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                <div class="preview-container" id="messagePreview">
                    <!-- תוכן התצוגה המקדימה יתמלא על ידי JavaScript -->
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-secondary me-md-2" onclick="document.getElementById('create-tab').click()">
                        <i class="bi bi-pencil"></i> ערוך
                    </button>
                    <button class="btn btn-primary" onclick="generatePDF()">
                        <i class="bi bi-file-earmark-pdf"></i> יצירת PDF
                    </button>
                </div>
            </div>

            <!-- PDF ושליחה -->
            <div class="tab-pane fade" id="pdf" role="tabpanel" aria-labelledby="pdf-tab">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>תצוגת PDF</h5>
                    </div>
                    <div class="card-body">
                        <iframe id="pdfPreview" frameborder="0"></iframe>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5>שליחת ההודעה</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="emailList" class="form-label">כתובות מייל (מופרדות בפסיק)</label>
                            <textarea class="form-control" id="emailList" rows="3" placeholder="example1@gmail.com, example2@gmail.com"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="emailSubject" class="form-label">נושא המייל</label>
                            <input type="text" class="form-control" id="emailSubject" value="למסירה - פריטים חדשים">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="btnSendEmail" onclick="sendEmail()">
                                <i class="bi bi-envelope"></i> שלח מייל
                            </button>
                            <button class="btn btn-success" id="btnDownloadPDF" onclick="downloadPDF()">
                                <i class="bi bi-download"></i> הורד PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- הגדרות -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>הגדרות המערכת</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="logoUpload" class="form-label">לוגו לתצוגה בהודעות</label>
                            <input class="form-control" type="file" id="logoUpload" accept="image/*">
                            <div id="logoPreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="footerText" class="form-label">טקסט קבוע לתחתית ההודעה</label>
                            <textarea class="form-control" id="footerText" rows="5">
כל הקודם זוכה
לפרסום מוצרים למסירה או להוספת חברים לקבוצה יש לשלוח מייל ל: mesira89@gmail.com
קישור ישיר להצטרפות מיידית לקבוצה: https://groups.google.com/g/mesira
--
בברכה
קבוצת מסירה - לתת מכל הלב

-- הקבוצה נפתחה לעילוי נשמת: "רותי בת מזל טוב" ו"רונן בן רותי" --- ‏</textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="includeUnsubscribe" checked>
                            <label class="form-check-label" for="includeUnsubscribe">הוסף קישור להסרה מהרשימה</label>
                        </div>
                        <div class="mb-3">
                            <label for="unsubscribeEmail" class="form-label">כתובת מייל להסרה</label>
                            <input type="email" class="form-control" id="unsubscribeEmail" value="mesira+unsubscribe@googlegroups.com">
                        </div>
                        <div class="mb-3">
                            <label for="colorTheme" class="form-label">ערכת צבעים</label>
                            <select class="form-select" id="colorTheme">
                                <option value="blue" selected>כחול</option>
                                <option value="green">ירוק</option>
                                <option value="purple">סגול</option>
                                <option value="orange">כתום</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="saveSettings" onclick="saveSettings()">
                            <i class="bi bi-save"></i> שמור הגדרות
                        </button>
                        <button class="btn btn-danger mt-4" id="clearAll" onclick="clearAllData()">
                            <i class="bi bi-trash"></i> מחק את כל הנתונים
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        let items = [];
        let uploadedImages = [];
        let pdfBlob = null;
        let logoImage = null;

        // ניתוח טקסט מיובא
        function parseImportedText() {
            const text = document.getElementById('importText').value;
            if (!text) {
                alert('נא להזין טקסט לניתוח');
                return;
            }

            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            // חיפוש כותרת (נניח שהשורה הראשונה היא הכותרת)
            if (lines.length > 0) {
                document.getElementById('title').value = lines[0];
            }
            
            // חיפוש פריטים (שורות בין הכותרת למיקום האיסוף)
            const itemsText = [];
            let foundItems = false;
            let foundLocation = false;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.includes('למסירה') && !foundItems) {
                    foundItems = true;
                    continue;
                }
                
                if (line.includes('מיקום האיסוף') || line.includes('מיקום איסוף')) {
                    foundLocation = true;
                    
                    // חילוץ מיקום האיסוף
                    const locationMatch = line.match(/(?:מיקום האיסוף|מיקום איסוף):\s*(.+)\./);
                    if (locationMatch && locationMatch[1]) {
                        document.getElementById('location').value = locationMatch[1].trim();
                    }
                    break;
                }
                
                if (foundItems && !foundLocation && !line.includes('מצ"ב תמונ')) {
                    itemsText.push(line);
                }
            }
            
            // מילוי פריטים
            items = [];
            itemsText.forEach(item => {
                if (item.startsWith('*')) {
                    items.push(item.substring(1).trim());
                } else if (item.startsWith('-')) {
                    items.push(item.substring(1).trim());
                } else {
                    items.push(item);
                }
            });
            renderItems();
            
            // חיפוש טלפון
            const phoneMatch = text.match(/(?:טלפון|פלאפון):\s*(\d+)/);
            if (phoneMatch && phoneMatch[1]) {
                document.getElementById('phone').value = phoneMatch[1].trim();
            }
            
            // חיפוש מייל
            const emailMatch = text.match(/(?:מייל|אימייל):\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            if (emailMatch && emailMatch[1]) {
                document.getElementById('email').value = emailMatch[1].trim();
            }
            
            alert('הטקסט נותח והשדות מולאו בהצלחה!');
        }
        
        // נקה טקסט מיובא
        function clearImportText() {
            document.getElementById('importText').value = '';
        }

        // הוספת פריטים לרשימה
        document.getElementById('addItem').addEventListener('click', function() {
            const newItem = document.getElementById('newItem').value.trim();
            if (newItem) {
                items.push(newItem);
                renderItems();
                document.getElementById('newItem').value = '';
            }
        });

        // מאזין להקלדה ב-Enter
        document.getElementById('newItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('addItem').click();
            }
        });

        // הצגת רשימת הפריטים
        function renderItems() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';
            
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${item}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${index})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                itemsList.appendChild(li);
            });
        }

        // עריכת פריט
        function editItem(index) {
            const newText = prompt('ערוך פריט:', items[index]);
            if (newText !== null) {
                items[index] = newText;
                renderItems();
            }
        }

        // הסרת פריט
        function removeItem(index) {
            if (confirm('האם אתה בטוח שברצונך למחוק פריט זה?')) {
                items.splice(index, 1);
                renderItems();
            }
        }

        // העלאת תמונות
        document.getElementById('formFileMultiple').addEventListener('change', function(event) {
            const files = event.target.files;
            const imagePreview = document.getElementById('imagePreview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        uploadedImages.push(e.target.result);
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'position-relative';
                        imgContainer.appendChild(img);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-1';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.onclick = function() {
                            const index = uploadedImages.indexOf(e.target.result);
                            if (index > -1) {
                                uploadedImages.splice(index, 1);
                                imgContainer.remove();
                            }
                        };
                        
                        imgContainer.appendChild(removeBtn);
                        imagePreview.appendChild(imgContainer);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        });

        // טיפול בלוגו
        document.getElementById('logoUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    logoImage = e.target.result;
                    
                    const logoPreview = document.getElementById('logoPreview');
                    logoPreview.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'logo-preview';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-outline-danger d-block mt-2';
                    removeBtn.innerHTML = '<i class="bi bi-trash"></i> הסר לוגו';
                    removeBtn.onclick = function() {
                        logoImage = null;
                        logoPreview.innerHTML = '';
                        document.getElementById('logoUpload').value = '';
                    };
                    
                    logoPreview.appendChild(img);
                    logoPreview.appendChild(removeBtn);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // מעבר לתצוגה מקדימה
        function showPreviewTab() {
            generatePreview();
            document.getElementById('preview-tab').click();
        }

        // יצירת תצוגה מקדימה
        function generatePreview() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const location = document.getElementById('location').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const footerText = document.getElementById('footerText').value;
            
            let logoHtml = '';
            if (logoImage) {
                logoHtml = `<div style="text-align: center; margin-bottom: 15px;">
                    <img src="${logoImage}" style="max-width: 200px; max-height: 100px;">
                </div>`;
            }
            
            let itemsHtml = '';
            if (items.length > 0) {
                itemsHtml = '<ul style="list-style-type: disc;">';
                items.forEach(item => {
                    itemsHtml += `<li><strong>${item}</strong></li>`;
                });
                itemsHtml += '</ul>';
            }
            
            let imagesHtml = '';
            if (uploadedImages.length > 0) {
                imagesHtml = '<p><strong>מצ"ב תמונות</strong></p><div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                uploadedImages.forEach(img => {
                    imagesHtml += `<img src="${img}" style="max-width: 200px; max-height: 200px; border-radius: 5px;">`;
                });
                imagesHtml += '</div>';
            }
            
            const previewHtml = `
                <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                    ${logoHtml}
                    <p><strong>${title}</strong></p>
                    <p><strong>${subtitle}</strong></p>
                    ${itemsHtml}
                    ${imagesHtml}
                    <p>כל הקודם זוכה</p>
                    <p>מיקום האיסוף: ${location}.</p>
                    <p>לפרטים:</p>
                    <p>פלאפון: <strong>${phone}</strong></p>
                    <p>מייל: <strong>${email}</strong></p>
                    <p>${footerText.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            
            document.getElementById('messagePreview').innerHTML = previewHtml;
        }

        // יצירת PDF
        function generatePDF() {
            const element = document.getElementById('messagePreview');
            const opt = {
                margin: 10,
                filename: 'למסירה.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().from(element).set(opt).outputPdf('blob').then(function(pdf) {
                pdfBlob = pdf;
                const pdfUrl = URL.createObjectURL(pdf);
                document.getElementById('pdfPreview').src = pdfUrl;
                document.getElementById('pdf-tab').click();
            });
        }

        // הורדת PDF
        function downloadPDF() {
            if (pdfBlob) {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'למסירה.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('יש ליצור קודם את קובץ ה-PDF');
            }
        }

        // שליחת מייל
        function sendEmail() {
            const emailList = document.getElementById('emailList').value;
            const emailSubject = document.getElementById('emailSubject').value;
            
            if (!emailList) {
                alert('נא להזין לפחות כתובת מייל אחת');
                return;
            }
            
            if (pdfBlob) {
                const mailtoLink = `mailto:${emailList}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent('מצ"ב פריטים למסירה.\n\nהקובץ זמין להורדה באתר המערכת.')}`;
                window.location.href = mailtoLink;
                
                alert('קישור המייל נפתח. לצערנו בגלל מגבלות אבטחה של הדפדפן, לא ניתן לצרף קבצים בצורה אוטומטית. יש להוריד את ה-PDF ולצרף אותו ידנית למייל.');
            } else {
                alert('יש ליצור קודם את קובץ ה-PDF');
            }
        }

        // שמירת הגדרות
        function saveSettings() {
            alert('ההגדרות נשמרו בהצלחה!');
        }

        // מחיקת כל הנתונים
        function clearAllData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים?')) {
                // ניקוי שדות הטקסט
                document.getElementById('title').value = '';
                document.getElementById('location').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('email').value = '';
                document.getElementById('importText').value = '';
                document.getElementById('emailList').value = '';
                
                // ניקוי רשימת הפריטים
                items = [];
                renderItems();
                
                // ניקוי תמונות
                uploadedImages = [];
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('formFileMultiple').value = '';
                
                alert('כל הנתונים נמחקו בהצלחה!');
            }
        }
    </script>
</body>
</html> 
