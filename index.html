<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת גמ"ח למסירה</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f1f8ff;
            border-bottom: 1px solid #e3f2fd;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .preview-container {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 20px;
            background-color: white;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .item-list {
            list-style-type: none;
            padding: 0;
        }
        .item-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #pdfPreview {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
        }
        .tab-content {
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: 0;
            border-radius: 0 0 5px 5px;
            padding: 20px;
        }
        .logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        #importSection {
            border: 2px dashed #3498db;
            padding: 20px;
            border-radius: 10px;
            background-color: #f7fbff;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="bi bi-gift"></i> מערכת גמ"ח למסירה</h1>
            <p class="lead">יצירת הודעות מסירה בקלות ובמהירות</p>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab" aria-controls="create" aria-selected="true">יצירת הודעה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">תצוגה מקדימה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf" type="button" role="tab" aria-controls="pdf" aria-selected="false">PDF ושליחה</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">הגדרות</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- יצירת הודעה חדשה -->
            <div class="tab-pane fade show active" id="create" role="tabpanel" aria-labelledby="create-tab">
                <!-- אזור ייבוא מטקסט -->
                <div id="importSection">
                    <h5><i class="bi bi-clipboard-data"></i> העתק והדבק מהמייל</h5>
                    <p class="small">העתק את הטקסט מהמייל והדבק כאן. המערכת תנסה למלא את השדות באופן אוטומטי.</p>
                    <div class="mb-3">
                        <textarea class="form-control" id="importText" rows="6" placeholder="הדבק את הטקסט המלא כאן..."></textarea>
                    </div>
                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-primary" id="btnImport" onclick="parseImportedText()">
                            <i class="bi bi-magic"></i> מלא שדות אוטומטית
                        </button>
                        <button class="btn btn-outline-secondary" id="btnClearImport" onclick="clearImportText()">
                            <i class="bi bi-trash"></i> נקה
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>פרטי ההודעה</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="title" class="form-label">כותרת</label>
                                    <input type="text" class="form-control" id="title" value="">
                                </div>
                                <div class="mb-3">
                                    <label for="subtitle" class="form-label">תת כותרת</label>
                                    <input type="text" class="form-control" id="subtitle" value="למסירה:">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">פריטים למסירה</label>
                                    <div class="input-group mb-2">
                                        <input type="text" id="newItem" class="form-control" placeholder="תיאור הפריט">
                                        <button class="btn btn-success" id="addItem"><i class="bi bi-plus-lg"></i> הוסף</button>
                                    </div>
                                    <ul class="item-list" id="itemsList"></ul>
                                </div>
                                <div class="mb-3">
                                    <label for="location" class="form-label">מיקום האיסוף</label>
                                    <input type="text" class="form-control" id="location" value="">
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">מספר טלפון</label>
                                    <input type="tel" class="form-control" id="phone" value="">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">כתובת מייל</label>
                                    <input type="email" class="form-control" id="email" value="">
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>תמונות</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="formFileMultiple" class="form-label">בחר תמונות להעלאה</label>
                                    <input class="form-control" type="file" id="formFileMultiple" multiple accept="image/*">
                                </div>
                                <div class="image-preview" id="imagePreview"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card sticky-top" style="top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>תצוגה מקדימה חיה</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshPreview()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="preview-container" id="quickPreview">
                                    <!-- תוכן התצוגה המקדימה יתמלא על ידי JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-primary" id="btnPreview" onclick="showPreviewTab()">
                        <i class="bi bi-eye"></i> תצוגה מקדימה מלאה
                    </button>
                </div>
            </div>

            <!-- תצוגה מקדימה -->
            <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                <div class="preview-container" id="messagePreview">
                    <!-- תוכן התצוגה המקדימה יתמלא על ידי JavaScript -->
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-secondary me-md-2" onclick="document.getElementById('create-tab').click()">
                        <i class="bi bi-pencil"></i> ערוך
                    </button>
                    <button class="btn btn-primary" onclick="generatePDF()">
                        <i class="bi bi-file-earmark-pdf"></i> יצירת PDF
                    </button>
                </div>
            </div>

            <!-- PDF ושליחה -->
            <div class="tab-pane fade" id="pdf" role="tabpanel" aria-labelledby="pdf-tab">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>תצוגת PDF</h5>
                    </div>
                    <div class="card-body">
                        <iframe id="pdfPreview" frameborder="0"></iframe>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5>שליחת ההודעה</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="emailList" class="form-label">כתובות מייל (מופרדות בפסיק)</label>
                            <textarea class="form-control" id="emailList" rows="3" placeholder="example1@gmail.com, example2@gmail.com"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="emailSubject" class="form-label">נושא המייל</label>
                            <input type="text" class="form-control" id="emailSubject" value="למסירה - פריטים חדשים">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="btnSendEmail" onclick="sendEmail()">
                                <i class="bi bi-envelope"></i> שלח מייל
                            </button>
                            <button class="btn btn-success" id="btnDownloadPDF" onclick="downloadPDF()">
                                <i class="bi bi-download"></i> הורד PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- הגדרות -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>הגדרות המערכת</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="logoUpload" class="form-label">לוגו לתצוגה בהודעות</label>
                            <input class="form-control" type="file" id="logoUpload" accept="image/*">
                            <div id="logoPreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="footerText" class="form-label">טקסט קבוע לתחתית ההודעה</label>
                            <textarea class="form-control" id="footerText" rows="5">לפרסום מוצרים למסירה או להוספת חברים לקבוצה יש לשלוח מייל ל: mesira89@gmail.com
קישור ישיר להצטרפות מיידית לקבוצה: https://groups.google.com/g/mesira
--
**בברכה**
**קבוצת מסירה - לתת מכל הלב**

-- הקבוצה נפתחה לעילוי נשמת: "רותי בת מזל טוב" ו"רונן בן רותי" --- ‏קיבלת את ההודעה הזו מפני שאתה רשום לקבוצה 'למסירה - הכל בחינם' של קבוצות Google. כדי לבטל את הרישום לקבוצה הזו ולהפסיק לקבל ממנה אימייל, שלח אימייל אל mesira+unsubscribe@googlegroups.com. כדי לראות את הדיון הזה, צריך להיכנס אל https://groups.google.com/d/msgid/mesira/CAFYjNFyho1uG7OfBPv6Et1nRQanvzCFpig5R8uNdUKQvt67W1A%40mail.gmail.com.</textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="includeUnsubscribe" checked>
                            <label class="form-check-label" for="includeUnsubscribe">הוסף קישור להסרה מהרשימה</label>
                        </div>
                        <div class="mb-3">
                            <label for="unsubscribeEmail" class="form-label">כתובת מייל להסרה</label>
                            <input type="email" class="form-control" id="unsubscribeEmail" value="mesira+unsubscribe@googlegroups.com">
                        </div>
                        <div class="mb-3">
                            <label for="colorTheme" class="form-label">ערכת צבעים</label>
                            <select class="form-select" id="colorTheme">
                                <option value="blue" selected>כחול</option>
                                <option value="green">ירוק</option>
                                <option value="purple">סגול</option>
                                <option value="orange">כתום</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="autoSave" checked>
                            <label class="form-check-label" for="autoSave">שמירה אוטומטית של נתונים</label>
                        </div>
                        <button class="btn btn-primary" id="saveSettings" onclick="saveSettings()">
                            <i class="bi bi-save"></i> שמור הגדרות
                        </button>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">יבוא ויצוא נתונים</label>
                                    <p class="small">ייצוא נתונים וייבוא במחשבים אחרים או בהתקנה חדשה</p>
                                    <button class="btn btn-outline-secondary" onclick="exportData()">
                                        <i class="bi bi-download"></i> ייצוא נתונים
                                    </button>
                                    <input type="file" id="importDataFile" class="d-none" accept=".json" onchange="importData(this)">
                                    <button class="btn btn-outline-secondary ms-2" onclick="document.getElementById('importDataFile').click()">
                                        <i class="bi bi-upload"></i> ייבוא נתונים
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ניקוי נתונים</label>
                                    <p class="small">מחיקת פריטים והגדרות מהמערכת</p>
                                    <button class="btn btn-danger" id="clearAll" onclick="clearAllData()">
                                        <i class="bi bi-trash"></i> מחק את כל הנתונים
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        let items = [];
        let uploadedImages = [];
        let pdfBlob = null;
        let logoImage = null;
        
        // טעינת הגדרות ונתונים
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadSavedData();
            applyColorTheme();
            
            // מאזינים לשינויים בשדות הטקסט לעדכון תצוגה מקדימה
            const textInputs = document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea:not(#importText)');
            textInputs.forEach(input => {
                input.addEventListener('input', debounce(function() {
                    refreshPreview();
                    if (document.getElementById('autoSave').checked) {
                        saveCurrentData();
                    }
                }, 500));
            });
            
            // רענון תצוגה מקדימה בעת טעינת הדף
            refreshPreview();
        });
        
        // פונקציית דיבאונס למניעת עומס
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // רענון תצוגה מקדימה חיה
        function refreshPreview() {
            generateQuickPreview();
        }
        
        // יצירת תצוגה מקדימה חיה
        function generateQuickPreview() {
            const title = document.getElementById('title').value || 'כותרת';
            const subtitle = document.getElementById('subtitle').value || 'תת כותרת';
            const location = document.getElementById('location').value || 'מיקום';
            const phone = document.getElementById('phone').value || 'טלפון';
            const email = document.getElementById('email').value || 'דוא"ל';
            const footerText = document.getElementById('footerText').value || '';
            
            let logoHtml = '';
            if (logoImage) {
                logoHtml = `<div style="text-align: center; margin-bottom: 15px;">
                    <img src="${logoImage}" style="max-width: 200px; max-height: 100px;">
                </div>`;
            }
            
            let itemsHtml = '';
            if (items.length > 0) {
                itemsHtml = '<ul style="list-style-type: disc;">';
                items.forEach(item => {
                    itemsHtml += `<li><strong>${item}</strong></li>`;
                });
                itemsHtml += '</ul>';
            } else {
                itemsHtml = '<p>אין פריטים למסירה</p>';
            }
            
            let imagesHtml = '';
            if (uploadedImages.length > 0) {
                imagesHtml = '<p style="margin: 3px 0 2px 0;"><strong>מצ"ב תמונות</strong></p>';
                
                if (uploadedImages.length === 1) {
                    // תמונה אחת - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 520 : 580;
                    imagesHtml += `<div style="text-align: center; margin-bottom: 5px;">
                        <img src="${uploadedImages[0].dataUrl || uploadedImages[0]}" style="max-width: 650px; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    </div>`;
                } else if (uploadedImages.length === 2) {
                    // שתי תמונות - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 380 : 420;
                    imagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 5px;">';
                    uploadedImages.forEach(img => {
                        imagesHtml += `<img src="${img.dataUrl || img}" style="max-width: 400px; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">`;
                    });
                    imagesHtml += '</div>';
                } else if (uploadedImages.length <= 3) {
                    // 3 תמונות - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 300 : 350;
                    imagesHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 5px;">';
                    uploadedImages.forEach(img => {
                        imagesHtml += `<div style="text-align: center;">
                            <img src="${img.dataUrl || img}" style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                        </div>`;
                    });
                    imagesHtml += '</div>';
                } else {
                    // מעל 3 תמונות - הגבל לכמות קטנה יותר אבל בגודל משמעותי
                    const maxHeight = footerText.length > 100 ? 220 : 250;
                    imagesHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 4px;">';
                    // הגבל ל-6 תמונות בלבד
                    const maxImagesToShow = Math.min(uploadedImages.length, 6);
                    for (let i = 0; i < maxImagesToShow; i++) {
                        const img = uploadedImages[i];
                        imagesHtml += `<div style="text-align: center;">
                            <img src="${img.dataUrl || img}" style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                        </div>`;
                    }
                    imagesHtml += '</div>';
                    
                    // אם יש יותר תמונות, הודע למשתמש
                    if (uploadedImages.length > 6) {
                        imagesHtml += `<p style="text-align: center; font-size: 0.75em; margin: 2px 0;">+ ${uploadedImages.length - 6} תמונות נוספות</p>`;
                    }
                }
            }
            
            // טקסט הפוטר - וודא שטקסט "בברכה" מופיע תמיד
            let footerHtml = '';
            if (footerText) {
                // חילוק הטקסט לשורות
                const footerLines = footerText.split('\n').filter(line => line.trim());
                
                // אתר את השורות החשובות
                const bruchaIndex = footerLines.findIndex(line => line.includes('ברכה'));
                const unsubscribeIndex = footerLines.findIndex(line => line.includes('לבטל את הרישום') || line.includes('unsubscribe'));
                
                // הגדר שורות חובה להצגה בהתאם למספר התמונות
                let mandatoryLines = [];
                
                // הוסף את שורות הברכה תמיד (2-3 שורות)
                if (bruchaIndex !== -1) {
                    for (let i = bruchaIndex; i < bruchaIndex + 3 && i < footerLines.length; i++) {
                        mandatoryLines.push(i);
                    }
                }
                
                // הוסף את שורת הסרת הרישום אם קיימת והמשתמש ביקש
                if (unsubscribeIndex !== -1 && document.getElementById('includeUnsubscribe').checked) {
                    mandatoryLines.push(unsubscribeIndex);
                }
                
                // החלט על מספר השורות הנוספות להצגה
                let additionalLines = uploadedImages.length > 3 ? 0 :
                                      uploadedImages.length > 1 ? 1 : 
                                      uploadedImages.length === 1 ? 2 : 4;
                
                // צור את רשימת כל האינדקסים להצגה
                let displayIndices = new Set(mandatoryLines);
                
                // הוסף שורות נוספות מההתחלה עד למגבלה
                let addedCount = 0;
                for (let i = 0; i < footerLines.length && addedCount < additionalLines; i++) {
                    if (!displayIndices.has(i)) {
                        displayIndices.add(i);
                        addedCount++;
                    }
                }
                
                // מיין את האינדקסים
                displayIndices = [...displayIndices].sort((a, b) => a - b);
                
                // בנה את הטקסט להצגה עם סימן "..." במקומות המתאימים
                let resultLines = [];
                let lastIndex = -1;
                
                displayIndices.forEach(index => {
                    // הוסף "..." אם יש פער של יותר משורה אחת
                    if (index > lastIndex + 1 && lastIndex !== -1) {
                        resultLines.push('...');
                    }
                    
                    // טיפול מיוחד בשורות בולטות: הוסף תגיות <strong> אם יש ** בטקסט
                    let line = footerLines[index];
                    if (line.includes('**')) {
                        line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    }
                    
                    // הוסף את השורה לתוצאה
                    resultLines.push(line);
                    lastIndex = index;
                });
                
                // הוסף "..." בסוף אם לא הצגנו את כל השורות
                if (lastIndex < footerLines.length - 1) {
                    resultLines.push('...');
                }
                
                // התאם את גודל הגופן לפי כמות התמונות והטקסט
                let footerFontSize = uploadedImages.length > 2 ? '0.7em' : '0.75em';
                
                // חבר את השורות לטקסט אחד
                footerHtml = `<span style="font-size: ${footerFontSize};">${resultLines.join('<br>')}</span>`;
            }
            
            const previewHtml = `
                <div style="font-family: Arial, sans-serif; line-height: 1.25; max-width: 100%; font-size: 0.85em; padding: 0;">
                    ${logoHtml}
                    <p style="font-size: 1em; margin: 3px 0;"><strong>${title}</strong></p>
                    <p style="font-size: 0.95em; margin: 3px 0;"><strong>${subtitle}</strong></p>
                    ${itemsHtml}
                    ${imagesHtml}
                    <p style="margin: 3px 0;">כל הקודם זוכה</p>
                    <p style="margin: 3px 0;">מיקום האיסוף: ${location}.</p>
                    <p style="margin: 3px 0;">לפרטים:</p>
                    <p style="margin: 3px 0;">פלאפון: <strong>${phone}</strong></p>
                    <p style="margin: 3px 0;">מייל: <strong>${email}</strong></p>
                    <p style="font-size: 0.75em; margin-top: 3px;">${footerHtml}</p>
                </div>
            `;
            
            document.getElementById('quickPreview').innerHTML = previewHtml;
        }

        // ניתוח טקסט מיובא
        function parseImportedText() {
            const text = document.getElementById('importText').value;
            if (!text) {
                alert('נא להזין טקסט לניתוח');
                return;
            }

            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            // חיפוש כותרת (נניח שהשורה הראשונה היא הכותרת)
            if (lines.length > 0) {
                document.getElementById('title').value = lines[0];
            }
            
            // חיפוש פריטים (שורות בין הכותרת למיקום האיסוף)
            const itemsText = [];
            let foundItems = false;
            let foundLocation = false;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                if ((line.includes('למסירה') || line.includes('מסירה:')) && !foundItems) {
                    foundItems = true;
                    // אם יש מידע אחרי "למסירה", נשמור אותו כפריט
                    const itemPart = line.split('למסירה').pop();
                    if (itemPart && itemPart.trim() && itemPart.trim() !== ':') {
                        itemsText.push(itemPart.trim());
                    }
                    continue;
                }
                
                if ((line.includes('מיקום האיסוף') || line.includes('מיקום איסוף') || line.includes('האיסוף:')) && !foundLocation) {
                    foundLocation = true;
                    
                    // חילוץ מיקום האיסוף
                    const locationMatch = line.match(/(?:מיקום האיסוף|מיקום איסוף|האיסוף):\s*([^.]+)/);
                    if (locationMatch && locationMatch[1]) {
                        document.getElementById('location').value = locationMatch[1].trim();
                    }
                    continue;
                }
                
                if (foundItems && !foundLocation) {
                    // בדיקה אם יש טקסט "מצ"ב תמונות" או דומה
                    if (line.includes('מצ"ב תמונ') || line.includes('מצורפ') || line.includes('תמונה מצורפת')) {
                        continue;
                    }
                    
                    // אם זו שורה ריקה, נדלג עליה
                    if (!line.trim()) {
                        continue;
                    }
                    
                    itemsText.push(line);
                }
                
                // חיפוש טלפון
                if (line.includes('טלפון:') || line.includes('פלאפון:') || line.includes('נייד:')) {
                    const phoneMatch = line.match(/(?:טלפון|פלאפון|נייד):\s*(\d+)/);
                    if (phoneMatch && phoneMatch[1]) {
                        document.getElementById('phone').value = phoneMatch[1].trim();
                    }
                }
                
                // חיפוש מייל
                if (line.includes('מייל:') || line.includes('אימייל:') || line.includes('דוא"ל:')) {
                    const emailMatch = line.match(/(?:מייל|אימייל|דוא"ל):\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if (emailMatch && emailMatch[1]) {
                        document.getElementById('email').value = emailMatch[1].trim();
                    }
                }
            }
            
            // אם לא מצאנו טלפון או מייל בשורות נפרדות, נחפש בכל הטקסט
            if (!document.getElementById('phone').value) {
                const phoneMatch = text.match(/(?:טלפון|פלאפון|נייד):\s*(\d+)/);
                if (phoneMatch && phoneMatch[1]) {
                    document.getElementById('phone').value = phoneMatch[1].trim();
                }
            }
            
            if (!document.getElementById('email').value) {
                const emailMatch = text.match(/(?:מייל|אימייל|דוא"ל):\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                if (emailMatch && emailMatch[1]) {
                    document.getElementById('email').value = emailMatch[1].trim();
                }
            }
            
            // מילוי פריטים
            items = [];
            itemsText.forEach(item => {
                let processedItem = item;
                // הסרת כוכביות, מקפים או תווים אחרים בתחילת השורה
                if (processedItem.startsWith('*')) {
                    processedItem = processedItem.substring(1).trim();
                } else if (processedItem.startsWith('-')) {
                    processedItem = processedItem.substring(1).trim();
                } else if (processedItem.startsWith('•')) {
                    processedItem = processedItem.substring(1).trim();
                }
                
                if (processedItem) {
                    items.push(processedItem);
                }
            });
            renderItems();
            
            // הוספת תצוגה מקדימה מהירה
            generatePreview();
            
            alert('הטקסט נותח והשדות מולאו בהצלחה!');
        }
        
        // נקה טקסט מיובא
        function clearImportText() {
            document.getElementById('importText').value = '';
        }

        // הוספת פריטים לרשימה
        document.getElementById('addItem').addEventListener('click', function() {
            const newItem = document.getElementById('newItem').value.trim();
            if (newItem) {
                items.push(newItem);
                renderItems();
                document.getElementById('newItem').value = '';
                refreshPreview();
                
                // שמירה אוטומטית
                if (document.getElementById('autoSave').checked) {
                    saveCurrentData();
                }
            }
        });

        // מאזין להקלדה ב-Enter
        document.getElementById('newItem').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('addItem').click();
            }
        });

        // הצגת רשימת הפריטים
        function renderItems() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';
            
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${item}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${index})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                itemsList.appendChild(li);
            });
        }

        // עריכת פריט
        function editItem(index) {
            const newText = prompt('ערוך פריט:', items[index]);
            if (newText !== null) {
                items[index] = newText;
                renderItems();
                refreshPreview();
                
                // שמירה אוטומטית
                if (document.getElementById('autoSave').checked) {
                    saveCurrentData();
                }
            }
        }

        // הסרת פריט
        function removeItem(index) {
            if (confirm('האם אתה בטוח שברצונך למחוק פריט זה?')) {
                items.splice(index, 1);
                renderItems();
                refreshPreview();
                
                // שמירה אוטומטית
                if (document.getElementById('autoSave').checked) {
                    saveCurrentData();
                }
            }
        }

        // העלאת תמונות
        document.getElementById('formFileMultiple').addEventListener('change', function(event) {
            const files = event.target.files;
            const imagePreview = document.getElementById('imagePreview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // הכן אובייקט עם מידע על התמונה אבל בלי לשמור את כל התוכן ב-localStorage
                        const imageObj = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            lastModified: file.lastModified,
                            dataUrl: e.target.result // נשתמש בזה להצגה, אבל לא נשמור אותו ב-localStorage
                        };
                        
                        uploadedImages.push(imageObj);
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'position-relative';
                        imgContainer.appendChild(img);
                        
                        // הוסף את שם הקובץ
                        const nameLabel = document.createElement('div');
                        nameLabel.className = 'text-center mt-1 small text-muted';
                        nameLabel.textContent = file.name.length > 20 ? file.name.substr(0, 17) + '...' : file.name;
                        imgContainer.appendChild(nameLabel);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-1';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.onclick = function() {
                            const index = uploadedImages.findIndex(img => img.name === file.name && img.lastModified === file.lastModified);
                            if (index > -1) {
                                uploadedImages.splice(index, 1);
                                imgContainer.remove();
                                refreshPreview();
                                
                                // שמירה אוטומטית
                                if (document.getElementById('autoSave').checked) {
                                    saveCurrentData();
                                }
                            }
                        };
                        
                        imgContainer.appendChild(removeBtn);
                        imagePreview.appendChild(imgContainer);
                        
                        refreshPreview();
                        
                        // שמירה אוטומטית
                        if (document.getElementById('autoSave').checked) {
                            saveCurrentData();
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        });

        // טיפול בלוגו
        document.getElementById('logoUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    logoImage = e.target.result;
                    
                    const logoPreview = document.getElementById('logoPreview');
                    logoPreview.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'logo-preview';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-outline-danger d-block mt-2';
                    removeBtn.innerHTML = '<i class="bi bi-trash"></i> הסר לוגו';
                    removeBtn.onclick = function() {
                        logoImage = null;
                        logoPreview.innerHTML = '';
                        document.getElementById('logoUpload').value = '';
                    };
                    
                    logoPreview.appendChild(img);
                    logoPreview.appendChild(removeBtn);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // מעבר לתצוגה מקדימה
        function showPreviewTab() {
            generatePreview();
            document.getElementById('preview-tab').click();
        }

        // יצירת תצוגה מקדימה
        function generatePreview() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const location = document.getElementById('location').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const footerText = document.getElementById('footerText').value;
            
            let logoHtml = '';
            if (logoImage) {
                logoHtml = `<div style="text-align: center; margin-bottom: 8px;">
                    <img src="${logoImage}" style="max-width: 200px; max-height: 80px;">
                </div>`;
            }
            
            let itemsHtml = '';
            if (items.length > 0) {
                itemsHtml = '<ul style="list-style-type: disc; margin: 6px 0; padding-right: 16px; padding-left: 16px;">';
                items.forEach(item => {
                    itemsHtml += `<li><strong>${item}</strong></li>`;
                });
                itemsHtml += '</ul>';
            }
            
            // הקטן את כמות התמונות לפי הכמות
            let imagesHtml = '';
            if (uploadedImages.length > 0) {
                imagesHtml = '<p style="margin: 3px 0 2px 0;"><strong>מצ"ב תמונות</strong></p>';
                
                if (uploadedImages.length === 1) {
                    // תמונה אחת - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 520 : 580;
                    imagesHtml += `<div style="text-align: center; margin-bottom: 5px;">
                        <img src="${uploadedImages[0].dataUrl || uploadedImages[0]}" style="max-width: 650px; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    </div>`;
                } else if (uploadedImages.length === 2) {
                    // שתי תמונות - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 380 : 420;
                    imagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 5px;">';
                    uploadedImages.forEach(img => {
                        imagesHtml += `<img src="${img.dataUrl || img}" style="max-width: 400px; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">`;
                    });
                    imagesHtml += '</div>';
                } else if (uploadedImages.length <= 3) {
                    // 3 תמונות - הגדל משמעותית
                    const maxHeight = footerText.length > 100 ? 300 : 350;
                    imagesHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 5px;">';
                    uploadedImages.forEach(img => {
                        imagesHtml += `<div style="text-align: center;">
                            <img src="${img.dataUrl || img}" style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                        </div>`;
                    });
                    imagesHtml += '</div>';
                } else {
                    // מעל 3 תמונות - הגבל לכמות קטנה יותר אבל בגודל משמעותי
                    const maxHeight = footerText.length > 100 ? 220 : 250;
                    imagesHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 4px;">';
                    // הגבל ל-6 תמונות בלבד
                    const maxImagesToShow = Math.min(uploadedImages.length, 6);
                    for (let i = 0; i < maxImagesToShow; i++) {
                        const img = uploadedImages[i];
                        imagesHtml += `<div style="text-align: center;">
                            <img src="${img.dataUrl || img}" style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                        </div>`;
                    }
                    imagesHtml += '</div>';
                    
                    // אם יש יותר תמונות, הודע למשתמש
                    if (uploadedImages.length > 6) {
                        imagesHtml += `<p style="text-align: center; font-size: 0.75em; margin: 2px 0;">+ ${uploadedImages.length - 6} תמונות נוספות</p>`;
                    }
                }
            }
            
            // טקסט הפוטר - וודא שטקסט "בברכה" מופיע תמיד
            let footerHtml = '';
            if (footerText) {
                // חילוק הטקסט לשורות
                const footerLines = footerText.split('\n').filter(line => line.trim());
                
                // אתר את השורות החשובות
                const bruchaIndex = footerLines.findIndex(line => line.includes('ברכה'));
                const unsubscribeIndex = footerLines.findIndex(line => line.includes('לבטל את הרישום') || line.includes('unsubscribe'));
                
                // הגדר שורות חובה להצגה בהתאם למספר התמונות
                let mandatoryLines = [];
                
                // הוסף את שורות הברכה תמיד (2-3 שורות)
                if (bruchaIndex !== -1) {
                    for (let i = bruchaIndex; i < bruchaIndex + 3 && i < footerLines.length; i++) {
                        mandatoryLines.push(i);
                    }
                }
                
                // הוסף את שורת הסרת הרישום אם קיימת והמשתמש ביקש
                if (unsubscribeIndex !== -1 && document.getElementById('includeUnsubscribe').checked) {
                    mandatoryLines.push(unsubscribeIndex);
                }
                
                // החלט על מספר השורות הנוספות להצגה
                let additionalLines = uploadedImages.length > 3 ? 0 :
                                      uploadedImages.length > 1 ? 1 : 
                                      uploadedImages.length === 1 ? 2 : 4;
                
                // צור את רשימת כל האינדקסים להצגה
                let displayIndices = new Set(mandatoryLines);
                
                // הוסף שורות נוספות מההתחלה עד למגבלה
                let addedCount = 0;
                for (let i = 0; i < footerLines.length && addedCount < additionalLines; i++) {
                    if (!displayIndices.has(i)) {
                        displayIndices.add(i);
                        addedCount++;
                    }
                }
                
                // מיין את האינדקסים
                displayIndices = [...displayIndices].sort((a, b) => a - b);
                
                // בנה את הטקסט להצגה עם סימן "..." במקומות המתאימים
                let resultLines = [];
                let lastIndex = -1;
                
                displayIndices.forEach(index => {
                    // הוסף "..." אם יש פער של יותר משורה אחת
                    if (index > lastIndex + 1 && lastIndex !== -1) {
                        resultLines.push('...');
                    }
                    
                    // טיפול מיוחד בשורות בולטות: הוסף תגיות <strong> אם יש ** בטקסט
                    let line = footerLines[index];
                    if (line.includes('**')) {
                        line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    }
                    
                    // הוסף את השורה לתוצאה
                    resultLines.push(line);
                    lastIndex = index;
                });
                
                // הוסף "..." בסוף אם לא הצגנו את כל השורות
                if (lastIndex < footerLines.length - 1) {
                    resultLines.push('...');
                }
                
                // התאם את גודל הגופן לפי כמות התמונות והטקסט
                let footerFontSize = uploadedImages.length > 2 ? '0.7em' : '0.75em';
                
                // חבר את השורות לטקסט אחד
                footerHtml = `<span style="font-size: ${footerFontSize};">${resultLines.join('<br>')}</span>`;
            }
            
            const previewHtml = `
                <div style="font-family: Arial, sans-serif; line-height: 1.25; max-width: 100%; font-size: 0.85em; padding: 0;">
                    ${logoHtml}
                    <p style="font-size: 1em; margin: 3px 0;"><strong>${title}</strong></p>
                    <p style="font-size: 0.95em; margin: 3px 0;"><strong>${subtitle}</strong></p>
                    ${itemsHtml}
                    ${imagesHtml}
                    <p style="margin: 3px 0;">כל הקודם זוכה</p>
                    <p style="margin: 3px 0;">מיקום האיסוף: ${location}.</p>
                    <p style="margin: 3px 0;">לפרטים:</p>
                    <p style="margin: 3px 0;">פלאפון: <strong>${phone}</strong></p>
                    <p style="margin: 3px 0;">מייל: <strong>${email}</strong></p>
                    <p style="font-size: 0.75em; margin-top: 3px;">${footerHtml}</p>
                </div>
            `;
            
            document.getElementById('messagePreview').innerHTML = previewHtml;
        }

        // יצירת PDF
        function generatePDF() {
            const element = document.getElementById('messagePreview');
            
            // הגדרות PDF מיוחדות לדף A4 אחד
            const opt = {
                margin: [5, 5, 5, 5], // עליון, שמאל, תחתון, ימין - הקטנת השוליים עוד יותר
                filename: 'למסירה.pdf',
                image: { type: 'jpeg', quality: 0.92 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true,
                    hotfixes: ["px_scaling"]
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // הצג הודעת טעינה
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'alert alert-info text-center';
            loadingMessage.innerHTML = '<i class="bi bi-hourglass-split"></i> יוצר PDF, אנא המתן...';
            element.parentNode.insertBefore(loadingMessage, element.nextSibling);
            
            // לפני יצירת ה-PDF, בדוק שאין חריגות גובה
            const originalHTML = element.innerHTML;
            
            // זמנית הוסף סגנון עם מגבלות של דף A4
            const tempStyle = document.createElement('style');
            tempStyle.textContent = `
                #messagePreview {
                    max-height: 280mm; /* A4 height minus margins */
                    overflow: hidden;
                    box-sizing: border-box;
                    page-break-inside: avoid;
                }
                #messagePreview * {
                    page-break-inside: avoid;
                }
            `;
            document.head.appendChild(tempStyle);
            
            // ייצור ה-PDF
            html2pdf().from(element).set(opt).outputPdf('blob').then(function(pdf) {
                // החזר את ה-HTML המקורי
                document.head.removeChild(tempStyle);
                element.innerHTML = originalHTML;
                
                pdfBlob = pdf;
                const pdfUrl = URL.createObjectURL(pdf);
                document.getElementById('pdfPreview').src = pdfUrl;
                document.getElementById('pdf-tab').click();
                
                // הסרת הודעת הטעינה
                loadingMessage.remove();
            }).catch(function(error) {
                // במקרה של שגיאה, החזר את ה-HTML המקורי
                document.head.removeChild(tempStyle);
                element.innerHTML = originalHTML;
                
                console.error('שגיאה ביצירת PDF:', error);
                alert('אירעה שגיאה ביצירת קובץ ה-PDF. אנא נסה שוב או הקטן את מספר התמונות/אורך הטקסט.');
                loadingMessage.remove();
            });
        }

        // הורדת PDF
        function downloadPDF() {
            if (pdfBlob) {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'למסירה.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('יש ליצור קודם את קובץ ה-PDF');
            }
        }

        // שליחת מייל
        function sendEmail() {
            const emailList = document.getElementById('emailList').value;
            const emailSubject = document.getElementById('emailSubject').value;
            
            if (!emailList) {
                alert('נא להזין לפחות כתובת מייל אחת');
                return;
            }
            
            if (pdfBlob) {
                const mailtoLink = `mailto:${emailList}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent('מצ"ב פריטים למסירה.\n\nהקובץ זמין להורדה באתר המערכת.')}`;
                window.location.href = mailtoLink;
                
                alert('קישור המייל נפתח. לצערנו בגלל מגבלות אבטחה של הדפדפן, לא ניתן לצרף קבצים בצורה אוטומטית. יש להוריד את ה-PDF ולצרף אותו ידנית למייל.');
            } else {
                alert('יש ליצור קודם את קובץ ה-PDF');
            }
        }

        // טיפול בשינוי ערכת צבעים
        document.getElementById('colorTheme').addEventListener('change', function() {
            applyColorTheme();
            saveSettings();
        });
        
        // החלת ערכת צבעים על הממשק
        function applyColorTheme() {
            const theme = document.getElementById('colorTheme').value;
            const header = document.querySelector('.header');
            const buttons = document.querySelectorAll('.btn-primary');
            
            // איפוס סגנונות קודמים
            header.style.background = '';
            buttons.forEach(btn => {
                btn.style.backgroundColor = '';
                btn.style.borderColor = '';
            });
            
            // החלת ערכת הצבעים החדשה
            switch (theme) {
                case 'green':
                    header.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
                    buttons.forEach(btn => {
                        btn.style.backgroundColor = '#27ae60';
                        btn.style.borderColor = '#27ae60';
                    });
                    break;
                case 'purple':
                    header.style.background = 'linear-gradient(45deg, #8e44ad, #9b59b6)';
                    buttons.forEach(btn => {
                        btn.style.backgroundColor = '#8e44ad';
                        btn.style.borderColor = '#8e44ad';
                    });
                    break;
                case 'orange':
                    header.style.background = 'linear-gradient(45deg, #d35400, #e67e22)';
                    buttons.forEach(btn => {
                        btn.style.backgroundColor = '#d35400';
                        btn.style.borderColor = '#d35400';
                    });
                    break;
                // ברירת מחדל - כחול
                default:
                    header.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
                    buttons.forEach(btn => {
                        btn.style.backgroundColor = '#3498db';
                        btn.style.borderColor = '#3498db';
                    });
            }
        }
        
        // שמירת הגדרות בלוקל סטורג'
        function saveSettings() {
            const settings = {
                colorTheme: document.getElementById('colorTheme').value,
                footerText: document.getElementById('footerText').value,
                includeUnsubscribe: document.getElementById('includeUnsubscribe').checked,
                unsubscribeEmail: document.getElementById('unsubscribeEmail').value,
                logo: logoImage
            };
            
            try {
                localStorage.setItem('gmachSettings', JSON.stringify(settings));
                alert('ההגדרות נשמרו בהצלחה!');
            } catch (e) {
                console.error('שגיאה בשמירת ההגדרות:', e);
                alert('אירעה שגיאה בשמירת ההגדרות');
            }
        }
        
        // טעינת הגדרות מלוקל סטורג'
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('gmachSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    // החלת ההגדרות
                    document.getElementById('colorTheme').value = settings.colorTheme || 'blue';
                    document.getElementById('footerText').value = settings.footerText || '';
                    document.getElementById('includeUnsubscribe').checked = settings.includeUnsubscribe !== false;
                    document.getElementById('unsubscribeEmail').value = settings.unsubscribeEmail || '';
                    
                    // טעינת לוגו אם יש
                    if (settings.logo) {
                        logoImage = settings.logo;
                        const logoPreview = document.getElementById('logoPreview');
                        logoPreview.innerHTML = '';
                        
                        const img = document.createElement('img');
                        img.src = settings.logo;
                        img.className = 'logo-preview';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-sm btn-outline-danger d-block mt-2';
                        removeBtn.innerHTML = '<i class="bi bi-trash"></i> הסר לוגו';
                        removeBtn.onclick = function() {
                            logoImage = null;
                            logoPreview.innerHTML = '';
                            document.getElementById('logoUpload').value = '';
                        };
                        
                        logoPreview.appendChild(img);
                        logoPreview.appendChild(removeBtn);
                    }
                }
            } catch (e) {
                console.error('שגיאה בטעינת ההגדרות:', e);
            }
        }

        // מחיקת כל הנתונים
        function clearAllData() {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים?')) {
                // ניקוי שדות הטקסט
                document.getElementById('title').value = '';
                document.getElementById('subtitle').value = 'למסירה:';
                document.getElementById('location').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('email').value = '';
                document.getElementById('importText').value = '';
                document.getElementById('emailList').value = '';
                
                // ניקוי רשימת הפריטים
                items = [];
                renderItems();
                
                // ניקוי תמונות
                uploadedImages = [];
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('formFileMultiple').value = '';
                
                // ניקוי נתונים שמורים
                localStorage.removeItem('gmachCurrentData');
                
                // רענון תצוגה מקדימה
                refreshPreview();
                
                alert('כל הנתונים נמחקו בהצלחה!');
            }
        }

        // שמירת נתונים נוכחיים (לא הגדרות)
        function saveCurrentData() {
            try {
                // שמירת מידע בסיסי
                const basicData = {
                    title: document.getElementById('title').value,
                    subtitle: document.getElementById('subtitle').value,
                    items: items,
                    location: document.getElementById('location').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                };
                
                // שמירת מידע על התמונות (ללא ה-dataUrl)
                const imagesMetadata = uploadedImages.map(img => {
                    if (typeof img === 'string') {
                        return { legacy: true, dataUrl: img }; // תמיכה בפורמט ישן
                    }
                    
                    // שמירת המטא-דאטה בלבד ללא התוכן
                    return {
                        name: img.name,
                        type: img.type,
                        size: img.size,
                        lastModified: img.lastModified
                    };
                });
                
                basicData.uploadedImagesInfo = imagesMetadata;
                
                localStorage.setItem('gmachCurrentData', JSON.stringify(basicData));
                console.log('נתונים בסיסיים נשמרו');
            } catch (e) {
                console.error('שגיאה בשמירת נתונים:', e);
            }
        }
        
        // טעינת נתונים שמורים
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('gmachCurrentData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // טעינת נתונים
                    document.getElementById('title').value = data.title || '';
                    document.getElementById('subtitle').value = data.subtitle || 'למסירה:';
                    items = data.items || [];
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('email').value = data.email || '';
                    
                    // לגבי התמונות - שומרים את המטא-דאטה, אבל צריך להעלות אותן שוב
                    if (data.uploadedImagesInfo && data.uploadedImagesInfo.length > 0) {
                        // אם יש תמונות ישנות שנשמרו כמחרוזות Base64
                        if (data.uploadedImages && data.uploadedImages.length > 0) {
                            uploadedImages = data.uploadedImages.map(img => ({
                                name: 'תמונה שמורה',
                                type: 'image/jpeg',
                                dataUrl: img
                            }));
                            
                            showImagePlaceholders();
                        } else {
                            // הצג הודעה שצריך להעלות מחדש את התמונות
                            const imagePreview = document.getElementById('imagePreview');
                            if (data.uploadedImagesInfo.length > 0) {
                                const msgElement = document.createElement('div');
                                msgElement.className = 'alert alert-info';
                                msgElement.innerHTML = 
                                    `<i class="bi bi-info-circle"></i> נמצאו ${data.uploadedImagesInfo.length} תמונות בנתונים השמורים. 
                                    <br>אנא העלה מחדש את התמונות כדי להשתמש בהן.`;
                                imagePreview.appendChild(msgElement);
                            }
                        }
                    }
                    
                    // עדכון רשימת הפריטים
                    renderItems();
                }
            } catch (e) {
                console.error('שגיאה בטעינת נתונים שמורים:', e);
            }
        }
        
        // הצג את התמונות השמורות
        function showImagePlaceholders() {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = '';
            
            uploadedImages.forEach((imgData, index) => {
                const img = document.createElement('img');
                if (imgData.dataUrl) {
                    img.src = imgData.dataUrl;
                } else if (typeof imgData === 'string') {
                    img.src = imgData;
                }
                
                img.className = 'preview-image';
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'position-relative';
                imgContainer.appendChild(img);
                
                // הוסף את שם הקובץ אם יש
                if (imgData.name) {
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'text-center mt-1 small text-muted';
                    nameLabel.textContent = imgData.name.length > 20 ? imgData.name.substr(0, 17) + '...' : imgData.name;
                    imgContainer.appendChild(nameLabel);
                }
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-1';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.onclick = function() {
                    uploadedImages.splice(index, 1);
                    imgContainer.remove();
                    refreshPreview();
                    
                    // שמירה אוטומטית
                    if (document.getElementById('autoSave').checked) {
                        saveCurrentData();
                    }
                };
                
                imgContainer.appendChild(removeBtn);
                imagePreview.appendChild(imgContainer);
            });
        }
        
        // ייצוא נתונים לקובץ JSON
        function exportData() {
            alert('מייצא נתונים כולל תמונות. זה עשוי לקחת זמן...');
            
            // איסוף כל הנתונים
            const allData = {
                settings: {
                    colorTheme: document.getElementById('colorTheme').value,
                    footerText: document.getElementById('footerText').value,
                    includeUnsubscribe: document.getElementById('includeUnsubscribe').checked,
                    unsubscribeEmail: document.getElementById('unsubscribeEmail').value,
                    logo: logoImage,
                    autoSave: document.getElementById('autoSave').checked
                },
                currentData: {
                    title: document.getElementById('title').value,
                    subtitle: document.getElementById('subtitle').value,
                    items: items,
                    location: document.getElementById('location').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    // כאן נשמור את התמונות המלאות כדי שאפשר יהיה לייבא אותן במחשב אחר
                    uploadedImages: uploadedImages
                }
            };
            
            // המרה ל-JSON
            const jsonData = JSON.stringify(allData, null, 2);
            
            // יצירת קובץ להורדה
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'גמח_מסירה_נתונים.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ייבוא נתונים מקובץ JSON
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ייבוא הגדרות
                    if (data.settings) {
                        document.getElementById('colorTheme').value = data.settings.colorTheme || 'blue';
                        document.getElementById('footerText').value = data.settings.footerText || '';
                        document.getElementById('includeUnsubscribe').checked = data.settings.includeUnsubscribe !== false;
                        document.getElementById('unsubscribeEmail').value = data.settings.unsubscribeEmail || '';
                        document.getElementById('autoSave').checked = data.settings.autoSave !== false;
                        
                        // טעינת לוגו
                        if (data.settings.logo) {
                            logoImage = data.settings.logo;
                            const logoPreview = document.getElementById('logoPreview');
                            logoPreview.innerHTML = '';
                            
                            const img = document.createElement('img');
                            img.src = data.settings.logo;
                            img.className = 'logo-preview';
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'btn btn-sm btn-outline-danger d-block mt-2';
                            removeBtn.innerHTML = '<i class="bi bi-trash"></i> הסר לוגו';
                            removeBtn.onclick = function() {
                                logoImage = null;
                                logoPreview.innerHTML = '';
                                document.getElementById('logoUpload').value = '';
                                saveSettings();
                            };
                            
                            logoPreview.appendChild(img);
                            logoPreview.appendChild(removeBtn);
                        }
                        
                        // החלת ערכת צבעים
                        applyColorTheme();
                    }
                    
                    // ייבוא נתונים נוכחיים
                    if (data.currentData) {
                        document.getElementById('title').value = data.currentData.title || '';
                        document.getElementById('subtitle').value = data.currentData.subtitle || 'למסירה:';
                        items = data.currentData.items || [];
                        document.getElementById('location').value = data.currentData.location || '';
                        document.getElementById('phone').value = data.currentData.phone || '';
                        document.getElementById('email').value = data.currentData.email || '';
                        
                        // טיפול בתמונות
                        uploadedImages = [];
                        const imagePreview = document.getElementById('imagePreview');
                        imagePreview.innerHTML = '';
                        
                        if (data.currentData.uploadedImages && data.currentData.uploadedImages.length > 0) {
                            // בדיקה מה סוג התמונות שיובאו
                            data.currentData.uploadedImages.forEach(img => {
                                // תמונות בפורמט החדש (אובייקטים עם dataUrl)
                                if (typeof img === 'object' && img.dataUrl) {
                                    uploadedImages.push(img);
                                }
                                // תמונות בפורמט הישן (מחרוזות base64)
                                else if (typeof img === 'string') {
                                    uploadedImages.push({
                                        name: 'תמונה מיובאת',
                                        type: 'image/jpeg',
                                        dataUrl: img
                                    });
                                }
                            });
                            
                            showImagePlaceholders(); // מציג את התמונות המיובאות
                        }
                        
                        // עדכון רשימת הפריטים
                        renderItems();
                    }
                    
                    // שמירת הנתונים וההגדרות
                    saveSettings();
                    saveCurrentData();
                    
                    // רענון תצוגה מקדימה
                    refreshPreview();
                    
                    alert('הנתונים יובאו בהצלחה!');
                } catch (e) {
                    console.error('שגיאה בייבוא נתונים:', e);
                    alert('אירעה שגיאה בייבוא הנתונים. אנא ודא שהקובץ תקין.');
                }
                
                // איפוס שדה הקובץ
                input.value = '';
            };
            
            reader.readAsText(file);
        }
    </script>
</body>
</html> 
